# 3 Musketeers Build System - BIAN Go\n\n> \"All for one, one for all\" - Consistent builds across all environments\n\nThis project uses the **3 Musketeers** pattern for build automation, ensuring consistent, reproducible builds across all development environments and CI/CD platforms.\n\n## üéØ The 3 Musketeers\n\n1. **Make** - Unified command interface\n2. **Docker** - Consistent runtime environment  \n3. **Docker Compose** - Multi-container orchestration (when needed)\n\n### Core Principles\n\n- **Consistency** - Same commands work everywhere (local, CI/CD)\n- **Control** - Locked tool versions, no \"works on my machine\"\n- **Confidence** - Reproducible builds, predictable outcomes\n\n## üöÄ Quick Start\n\n### Prerequisites\n\n- **Make** (usually pre-installed on Linux/macOS, [install on Windows](https://gnuwin32.sourceforge.net/packages/make.htm))\n- **Docker** or **Podman**\n- **Docker Compose** (optional, only for `make run` and `make run-dev`)\n\n### First Run\n\n```bash\n# Initialize project\nmake init\n\n# Build the project\nmake build\n\n# Run tests\nmake test\n\n# Start development server with hot reload\nmake run-dev\n```\n\n**That's it!** No Go installation required.\n\n## üìã Available Commands\n\n### Development\n\n```bash\nmake init          # Initialize project (download dependencies)\nmake build         # Build the project\nmake generate      # Run go generate (GraphQL code generation)\nmake test          # Run tests\nmake test-coverage # Run tests with coverage\nmake test-short    # Run short tests only\nmake run           # Run example server (production mode)\nmake run-dev       # Run example server (development mode with hot reload)\n```\n\n### Validation\n\n```bash\nmake fmt           # Format code\nmake vet           # Vet code\nmake lint          # Run linter\nmake validate      # Run all validation checks (fmt, vet, lint, test)\n```\n\n### CI/CD\n\n```bash\nmake ci            # Run complete CI pipeline (init + validate + build)\n```\n\n### Docker\n\n```bash\nmake docker-build  # Build Docker image\nmake docker-run    # Run Docker container\n```\n\n### Utilities\n\n```bash\nmake clean         # Clean build artifacts\nmake clean-docker  # Clean Docker artifacts\nmake deps          # Download dependencies\nmake deps-update   # Update dependencies\nmake tidy          # Tidy go.mod\nmake shell         # Open interactive shell in container\nmake logs          # Show application logs\n```\n\n### OpenSpec\n\n```bash\nmake openspec-validate # Validate OpenSpec changes\nmake openspec-list     # List OpenSpec changes\n```\n\n## üèóÔ∏è Architecture\n\n### Hybrid Execution Model\n\nThis build system supports **both Docker and native execution**:\n\n- **In Container**: Commands run directly (no Docker overhead)\n- **On Host**: Commands run via Docker (consistent environment)\n\n```bash\n# Automatic detection\nmake build  # Uses Docker if not in container, direct if in container\n\n# Manual override\nDOCKER_RUN=\"podman run --rm -v $(PWD):/app -w /app\" make build\n```\n\n### Build vs Runtime Separation\n\n**Build/Test Commands** (Direct Docker Run):\n- `make build`, `make test`, `make lint` - Single container, no orchestration\n- Uses `DOCKER_RUN` variable for flexibility\n- Faster, simpler, less overhead\n\n**Runtime Commands** (Docker Compose):\n- `make run`, `make run-dev` - Multi-container scenarios\n- Uses `docker-compose.yml` for orchestration\n- Supports networking, volumes, service dependencies\n\n### Container Images\n\n- **Build/Test**: `golang:1.22-alpine` (official Go environment)\n- **Linting**: `golangci/golangci-lint:v1.55-alpine`\n- **Production**: Custom multi-stage build (see `Dockerfile`)\n\n## üîß Configuration\n\n### Environment Variables\n\n```bash\n# Container runtime (Docker or Podman)\nDOCKER_RUN=\"docker run --rm -v $(PWD):/app -w /app\"\nDOCKER_RUN=\"podman run --rm -v $(PWD):/app -w /app\"\n\n# Go image version\nGO_IMAGE=\"golang:1.22-alpine\"\n\n# Linter image version\nLINT_IMAGE=\"golangci/golangci-lint:v1.55-alpine\"\n```\n\n### Podman Support\n\n```bash\n# Use Podman instead of Docker\nexport DOCKER_RUN=\"podman run --rm -v $(PWD):/app -w /app\"\nmake build\n```\n\n## üöÄ Development Workflow\n\n### Daily Development\n\n```bash\n# Start development server with hot reload\nmake run-dev\n\n# In another terminal, run tests on file changes\nmake test\n\n# Format and validate before commit\nmake validate\n```\n\n### Hot Reload Development\n\n```bash\n# Start development server (http://localhost:8080)\nmake run-dev\n\n# Edit files - server automatically rebuilds and restarts\n# GraphQL Playground: http://localhost:8080/playground\n```\n\n### Production Testing\n\n```bash\n# Build production Docker image\nmake docker-build\n\n# Run production container\nmake docker-run\n\n# Test production endpoints\ncurl http://localhost:8080/health\n```\n\n## üîÑ CI/CD Integration\n\n### GitHub Actions\n\n```yaml\nname: CI\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Run CI Pipeline\n        run: make ci\n      - name: Build Docker Image\n        run: make docker-build\n```\n\n### GitLab CI\n\n```yaml\nstages:\n  - test\n  - build\n\ntest:\n  stage: test\n  image: docker:latest\n  services:\n    - docker:dind\n  script:\n    - make ci\n\nbuild:\n  stage: build\n  image: docker:latest\n  services:\n    - docker:dind\n  script:\n    - make docker-build\n```\n\n### Jenkins\n\n```groovy\npipeline {\n    agent any\n    stages {\n        stage('Test') {\n            steps {\n                sh 'make ci'\n            }\n        }\n        stage('Build') {\n            steps {\n                sh 'make docker-build'\n            }\n        }\n    }\n}\n```\n\n## üê≥ Dev Container Support\n\nThe Docker setup is designed to be easily convertible to a dev container:\n\n### VS Code Dev Container\n\nCreate `.devcontainer/devcontainer.json`:\n\n```json\n{\n  \"name\": \"BIAN Go Development\",\n  \"dockerComposeFile\": \"../docker-compose.yml\",\n  \"service\": \"dev\",\n  \"workspaceFolder\": \"/app\",\n  \"customizations\": {\n    \"vscode\": {\n      \"extensions\": [\n        \"golang.go\",\n        \"ms-vscode.vscode-json\"\n      ]\n    }\n  },\n  \"forwardPorts\": [8080],\n  \"postCreateCommand\": \"make init\"\n}\n```\n\n### GitHub Codespaces\n\nCreate `.devcontainer/devcontainer.json` (same as above) and push to GitHub. Codespaces will automatically use it.\n\n## üîç Troubleshooting\n\n### Common Issues\n\n**\"make: command not found\"**\n```bash\n# Linux/macOS\nsudo apt-get install make  # Ubuntu/Debian\nbrew install make          # macOS\n\n# Windows\n# Install from https://gnuwin32.sourceforge.net/packages/make.htm\n```\n\n**\"docker: command not found\"**\n```bash\n# Install Docker Desktop or Docker Engine\n# https://docs.docker.com/get-docker/\n```\n\n**Permission denied on Linux**\n```bash\n# Add user to docker group\nsudo usermod -aG docker $USER\n# Log out and back in\n```\n\n**Windows path issues**\n```bash\n# Use Git Bash or WSL2\n# Or set DOCKER_RUN with Windows paths\nset DOCKER_RUN=docker run --rm -v %CD%:/app -w /app\n```\n\n### Debug Mode\n\n```bash\n# Show what commands would run\nmake -n build\n\n# Verbose output\nmake build VERBOSE=1\n\n# Interactive shell in container\nmake shell\n```\n\n### Performance Issues\n\n```bash\n# Clean Docker cache\nmake clean-docker\n\n# Use local Go cache (if available)\nexport GOCACHE=/tmp/go-cache\nmake build\n```\n\n## üéØ Benefits\n\n### For Developers\n- **Zero setup** - Only need Make + Docker\n- **Consistent environment** - Same as CI/CD\n- **Fast onboarding** - New developers productive in minutes\n- **No version conflicts** - Isolated toolchain\n\n### For Teams\n- **Reproducible builds** - Same output everywhere\n- **Simplified CI/CD** - Single `make ci` command\n- **Cross-platform** - Works on Linux, macOS, Windows\n- **Future-proof** - Easy to update tool versions\n\n### For Operations\n- **Container-ready** - Production images included\n- **Security** - Non-root containers, minimal attack surface\n- **Monitoring** - Health checks, structured logging\n- **Scalability** - Kubernetes-ready architecture\n\n## üìö Learn More\n\n- [3 Musketeers Pattern](https://3musketeers.io/)\n- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)\n- [Make Tutorial](https://makefiletutorial.com/)\n- [Go in Docker](https://docs.docker.com/language/golang/)\n\n---\n\n**\"All for one, one for all\"** - One build system, all environments. üöÄ